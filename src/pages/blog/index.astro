---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import Search from '@/components/Search.astro';
import { getCollection } from 'astro:content';

// Get all published blog posts, sorted by publication date (newest first)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))].sort();

// Get post count
const postCount = sortedPosts.length;
---

<BaseLayout 
  title="Blog" 
  description={`Browse all ${postCount} blog posts about web development, technology, and more.`}
>
  <!-- Page Header -->
  <header class="text-center mb-12">
    <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
      Blog Posts
    </h1>
    <p class="text-xl text-zinc-400 mb-8">
      {postCount > 0 
        ? `${postCount} ${postCount === 1 ? 'post' : 'posts'} about web development, technology, and more.`
        : 'No posts published yet. Check back soon!'
      }
    </p>
    
    <!-- Search Component -->
    <div class="max-w-md mx-auto mb-8">
      <Search placeholder="Search blog posts..." />
    </div>
  </header>
  
  {postCount > 0 && (
    <div class="grid lg:grid-cols-4 gap-8">
      <!-- Main Content -->
      <main class="lg:col-span-3">
        <div class="mb-6">
          <h2 class="text-2xl font-semibold text-white mb-4">All Posts</h2>
          <p class="text-zinc-400 text-sm">
            Showing {postCount} {postCount === 1 ? 'post' : 'posts'}
          </p>
        </div>
        
        <ul class="space-y-6">
          {sortedPosts.map((post) => (
            <PostCard
              href={`/blog/${post.slug}`}
              title={post.data.title}
              description={post.data.description}
              date={post.data.pubDate}
              tags={post.data.tags}
            />
          ))}
        </ul>
      </main>
      
      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        <div class="sticky top-8 space-y-8">
          <!-- Tags Cloud -->
          {allTags.length > 0 && (
            <section class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4">Topics</h3>
              <div class="flex flex-wrap gap-2">
                {allTags.map((tag) => {
                  const tagCount = allPosts.filter(post => 
                    post.data.tags?.includes(tag)
                  ).length;
                  return (
                    <span class="inline-block bg-zinc-700 text-zinc-300 text-xs px-2 py-1 rounded hover:bg-zinc-600 transition-colors cursor-pointer">
                      #{tag} ({tagCount})
                    </span>
                  );
                })}
              </div>
            </section>
          )}
          
          <!-- Recent Posts -->
          <section class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Recent Posts</h3>
            <ul class="space-y-3">
              {sortedPosts.slice(0, 5).map((post) => (
                <li>
                  <a 
                    href={`/blog/${post.slug}`}
                    class="block text-sm text-zinc-300 hover:text-white transition-colors duration-200 line-clamp-2"
                  >
                    {post.data.title}
                  </a>
                  <time class="text-xs text-zinc-500">
                    {post.data.pubDate.toLocaleDateString('en-US', {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric'
                    })}
                  </time>
                </li>
              ))}
            </ul>
          </section>
          
          <!-- RSS Feed -->
          <section class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Stay Updated</h3>
            <p class="text-sm text-zinc-400 mb-4">
              Subscribe to get notified when new posts are published.
            </p>
            <a 
              href="/rss.xml" 
              class="inline-flex items-center gap-2 bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700 transition-colors duration-200"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3.429 2.571c8.571 0 15.429 6.857 15.429 15.429h-3.429c0-6.857-5.714-12.571-12.571-12.571v-2.857zM3.429 7.429c5.714 0 10.286 4.571 10.286 10.286h-3.429c0-3.714-3.143-6.857-6.857-6.857v-3.429zM6.857 15.429c0 1.143-0.857 2-2 2s-2-0.857-2-2 0.857-2 2-2 2 0.857 2 2z"></path>
              </svg>
              RSS Feed
            </a>
          </section>
        </div>
      </aside>
    </div>
  )}
  
  <!-- Empty State -->
  {postCount === 0 && (
    <div class="text-center py-16">
      <div class="text-6xl mb-6">üìù</div>
      <h2 class="text-2xl font-semibold text-white mb-4">No posts yet</h2>
      <p class="text-zinc-400 mb-8 max-w-md mx-auto">
        This blog is just getting started. Check back soon for new content, 
        or learn more about what's coming.
      </p>
      <div class="flex justify-center gap-4">
        <a 
          href="/" 
          class="bg-white text-zinc-900 px-6 py-3 rounded-lg font-semibold hover:bg-zinc-200 transition-colors duration-200"
        >
          Back to Home
        </a>
        <a 
          href="/about" 
          class="border border-zinc-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-zinc-800 transition-colors duration-200"
        >
          About This Blog
        </a>
      </div>
    </div>
  )}
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>